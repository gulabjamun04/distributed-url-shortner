
version: '3.8'
services:
  app:
    # --- FastAPI/Uvicorn Optimizations ---
    # UVICORN_WORKERS: Set to a value like 2x the number of CPU cores. '4' is a good starting point.
    # UVICORN_BACKLOG: Increases the number of queued connections Uvicorn will hold.
    # DEBUG: Must be 'false' for production performance.
    environment:
      - UVICORN_WORKERS=4
      - UVICORN_BACKLOG=2048
      - DEBUG=false
    # Command to run uvicorn with high-performance settings.
    # --loop uvloop: A much faster implementation of the asyncio event loop.
    # --http httptools: A faster HTTP parser.
  db-shard-0:
    # --- PostgreSQL Optimizations ---
    # max_connections: Allows more clients to connect. Default is 100.
    # shared_buffers: Sets memory for shared memory buffers. A good starting point is 25% of system memory.
    command: postgres -c max_connections=300 -c shared_buffers=256MB

  db-shard-1:
    command: postgres -c max_connections=300 -c shared_buffers=256MB

  db-shard-2:
    command: postgres -c max_connections=300 -c shared_buffers=256MB

  redis:
    # --- Redis Optimizations ---
    # maxclients: Increases the number of allowed concurrent clients.
    # maxmemory / maxmemory-policy: Sets a memory limit and an eviction policy to prevent Redis from consuming all system RAM.
    command: redis-server --maxclients 10000 --maxmemory 2gb --maxmemory-policy allkeys-lru
